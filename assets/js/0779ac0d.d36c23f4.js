"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["310067"],{123029:function(e,n,t){t.r(n),t.d(n,{default:()=>p,frontMatter:()=>a,metadata:()=>s,assets:()=>l,toc:()=>c,contentTitle:()=>i});var s=JSON.parse('{"id":"install/deploy-on-kubernetes/separating-storage-compute/install-doris-cluster","title":"Deploy Doris Cluster","description":"\x3c!--","source":"@site/versioned_docs/version-3.0/install/deploy-on-kubernetes/separating-storage-compute/install-doris-cluster.md","sourceDirName":"install/deploy-on-kubernetes/separating-storage-compute","slug":"/install/deploy-on-kubernetes/separating-storage-compute/install-doris-cluster","permalink":"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/install-doris-cluster","draft":false,"unlisted":false,"tags":[],"version":"3.0","frontMatter":{"title":"Deploy Doris Cluster","language":"en"},"sidebar":"docs","previous":{"title":"Config ComputeGroups","permalink":"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-cg"},"next":{"title":"Deploying on AWS","permalink":"/docs/3.0/install/deploy-on-cloud/doris-on-aws"}}'),o=t("785893"),r=t("250065");let a={title:"Deploy Doris Cluster",language:"en"},i=void 0,l={},c=[{value:"Step 1: Pre-deployment preparation",id:"step-1-pre-deployment-preparation",level:2},{value:"Step 2: Deploy the operator",id:"step-2-deploy-the-operator",level:2},{value:"Step 3: Deploy the compute-storage decoupled cluster",id:"step-3-deploy-the-compute-storage-decoupled-cluster",level:2},{value:"Step 4: Create a remote storage backend",id:"step-4-create-a-remote-storage-backend",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"The deployment of a compute-storage decoupled cluster on Kubernetes involves four main steps:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Pre-deployment preparation."}),"\n",(0,o.jsx)(n.li,{children:"Deploying the Doris Operator."}),"\n",(0,o.jsx)(n.li,{children:"Deploying the compute-storage decoupled cluster."}),"\n",(0,o.jsx)(n.li,{children:"Creating the storage backend."}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"step-1-pre-deployment-preparation",children:"Step 1: Pre-deployment preparation"}),"\n",(0,o.jsxs)(n.p,{children:['To deploy a compute-storage decoupled cluster on Kubernetes, you need to deploy FoundationDB in advance. If using virtual machines (VMs), ensure that the VMs can be accessed by services within the Kubernetes cluster. For deploying FoundationDB on VMs, refer to the "Pre-deployment Preparation" section of the ',(0,o.jsx)(n.a,{href:"../../../compute-storage-decoupled/before-deployment",children:"compute-storage decoupling deployment guide"}),". For deployment on Kubernetes, follow the instructions in the ",(0,o.jsx)(n.a,{href:"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/install-fdb",children:"FoundationDB on Kubernetes deployment guide"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"step-2-deploy-the-operator",children:"Step 2: Deploy the operator"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Create the resource definitions:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell"})}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["kubectl create -f ",(0,o.jsx)(n.a,{href:"https://raw.githubusercontent.com/apache/doris-operator/master/config/crd/bases/crds.yaml",children:"https://raw.githubusercontent.com/apache/doris-operator/master/config/crd/bases/crds.yaml"})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"\n2. Deploy the Doris Operator and its associated RBAC rules:\n\n```shell\nkubectl apply -f https://raw.githubusercontent.com/apache/doris-operator/master/config/operator/disaggregated-operator.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"Expected Results:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"kubectl -n doris get pods\nNAME                              READY   STATUS    RESTARTS   AGE\ndoris-operator-6b97df65c4-xwvw8   1/1     Running   0          19s\n"})}),"\n",(0,o.jsx)(n.h2,{id:"step-3-deploy-the-compute-storage-decoupled-cluster",children:"Step 3: Deploy the compute-storage decoupled cluster"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Download the example deployment configuration for the compute-storage decoupled cluster:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"curl -O https://raw.githubusercontent.com/apache/doris-operator/master/doc/examples/disaggregated/cluster/ddc-sample.yaml\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Configure FoundationDB access information."}),"\n",(0,o.jsxs)(n.p,{children:["The compute-storage decoupled version of Doris uses FoundationDB to store metadata. The access details for FoundationDB can be provided in the DorisDisaggregatedCluster under ",(0,o.jsx)(n.code,{children:"spec.metaService.fdb"})," in one of two ways: by directly specifying the access address or by using a ConfigMap that includes the access information."]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Direct Access Address Configuration"}),"\n",(0,o.jsx)(n.p,{children:"If FoundationDB is deployed outside of Kubernetes, you can specify its access address directly:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"spec:\n  metaService:\n    fdb:\n      address: ${fdbAddress}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Here, ${fdbAddress} refers to the client access address for FoundationDB. On Linux VMs, this is typically stored in ",(0,o.jsx)(n.code,{children:"/etc/foundationdb/fdb.cluster"}),". For more details, refer to the FoundationDB ",(0,o.jsx)(n.a,{href:"https://apple.github.io/foundationdb/administration.html#foundationdb-cluster-file",children:"cluster file documentation"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Using a ConfigMap Containing Access Information"}),"\n",(0,o.jsxs)(n.p,{children:["If FoundationDB is deployed using the ",(0,o.jsx)(n.a,{href:"https://github.com/FoundationDB/fdb-kubernetes-operator",children:"fdb-kubernetes-operator"}),', it will automatically generate a ConfigMap containing the access details. The name of the generated ConfigMap is based on the resource name used for the deployment and appended with "-config".']}),"\n",(0,o.jsxs)(n.p,{children:["To obtain the ConfigMap, refer to the ",(0,o.jsx)(n.a,{href:"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/install-fdb#retrieve-the-configmap-containing-foundationdb-access-information",children:'"Access Information" section'})," in the FoundationDB on Kubernetes deployment guide. Once you have the ConfigMap name and namespace, configure the DorisDisaggregatedCluster as follows:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"spec:\n  metaService:\n    fdb:\n      configMapNamespaceName:\n        name: ${foundationdbConfigMapName}\n        namespace: ${namespace}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Replace ${foundationdbConfigMapName} with the name of the ConfigMap and ${namespace} with the namespace where it is located."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Follow the instructions in the compute-storage decoupling Kubernetes deployment documentation to configure the metadata service (",(0,o.jsx)(n.a,{href:"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-ms",children:"metaService configuration"}),"), the FE cluster specifications (",(0,o.jsx)(n.a,{href:"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-fe",children:"FE cluster configuration"}),"), and the compute groups (",(0,o.jsx)(n.a,{href:"/docs/3.0/install/deploy-on-kubernetes/separating-storage-compute/config-cg",children:"compute group configuration"}),"). After completing the configuration, deploy the resources with the following command:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"kubectl apply -f ddc-sample.yaml\n"})}),"\n",(0,o.jsx)(n.p,{children:"Once the resources are applied, wait for the cluster to be automatically set up. The expected output is:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"kubectl get ddc\nNAME                         CLUSTERHEALTH   FEPHASE   CGCOUNT   CGAVAILABLECOUNT   CGFULLAVAILABLECOUNT\ntest-disaggregated-cluster   green           Ready     2         2                  2\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"step-4-create-a-remote-storage-backend",children:"Step 4: Create a remote storage backend"}),"\n",(0,o.jsxs)(n.p,{children:["Once the compute-storage decoupled cluster is set up, you need to execute the appropriate ",(0,o.jsx)(n.code,{children:"CREATE STORAGE VAULT"})," SQL statement through the client to create the storage backend for data persistence. You can enter the FE container and use the MySQL client to perform the creation."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Get the service.\nAfter the cluster is deployed, you can view the services exposed by the Doris Operator with the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"kubectl get svc\n"})}),"\n",(0,o.jsx)(n.p,{children:"The output will be similar to:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"NAME                                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                               AGE\ntest-disaggregated-cluster-fe            ClusterIP   10.96.147.97   <none>        8030/TCP,9020/TCP,9030/TCP,9010/TCP   15m\ntest-disaggregated-cluster-fe-internal   ClusterIP   None           <none>        9030/TCP                              15m\ntest-disaggregated-cluster-ms            ClusterIP   10.96.169.8    <none>        5000/TCP                              15m\ntest-disaggregated-cluster-cg1           ClusterIP   10.96.47.90    <none>        9060/TCP,8040/TCP,9050/TCP,8060/TCP   14m\ntest-disaggregated-cluster-cg2           ClusterIP   10.96.50.199   <none>        9060/TCP,8040/TCP,9050/TCP,8060/TCP   14m\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"MySQL client access."}),"\n",(0,o.jsx)(n.p,{children:"To create a pod with the MySQL client inside the Kubernetes cluster, use the following command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"kubectl run mysql-client --image=mysql:5.7 -it --rm --restart=Never -- /bin/bash\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Within the pod, you can connect to the Doris cluster using the FE service name:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"mysql -uroot -P9030 -h test-disaggregated-cluster-fe \n"})}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Create the Storage Backend.\nTo create a storage backend using an S3-compatible object storage, use the following example:\na. Create an S3 Storage Vault:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-mysql",children:'CREATE STORAGE VAULT IF NOT EXISTS s3_vault\n   PROPERTIES (\n       "type"="S3",\n       "s3.endpoint" = "oss-cn-beijing.aliyuncs.com",\n       "s3.region" = "bj",\n       "s3.bucket" = "bucket",\n       "s3.root.path" = "big/data/prefix",\n       "s3.access_key" = "your-ak",\n       "s3.secret_key" = "your-sk",\n       "provider" = "OSS" \n   );\n'})}),"\n",(0,o.jsx)(n.p,{children:"b. Set the Default Storage Vault."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-mysql",children:"SET s3_vault AS DEFAULT STORAGE VAULT;\n"})}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{title:"Tip",type:"tip",children:(0,o.jsxs)(n.p,{children:["The configuration details in the above commands are for illustrative purposes only and are not valid for real-world scenarios. Please refer to ",(0,o.jsx)(n.a,{href:"../../../compute-storage-decoupled/managing-storage-vault",children:"the Managing Storage Vaults section"})," for instructions on creating a usable storage backend."]})})]})}function p(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},250065:function(e,n,t){t.d(n,{Z:function(){return i},a:function(){return a}});var s=t(667294);let o={},r=s.createContext(o);function a(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);